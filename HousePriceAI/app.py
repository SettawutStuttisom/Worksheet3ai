# app.py
import streamlit as st
import pandas as pd
import joblib
import datetime
import numpy as np
import os
import subprocess

st.set_page_config(page_title="ðŸ  House Price Prediction", layout="centered")
st.title("ðŸ  à¸£à¸°à¸šà¸šà¸—à¸³à¸™à¸²à¸¢à¸£à¸²à¸„à¸²à¸šà¹‰à¸²à¸™à¸”à¹‰à¸§à¸¢ AI (à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¸™à¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ)")
st.write("à¹‚à¸¡à¹€à¸”à¸¥ Random Forest à¸žà¸£à¹‰à¸­à¸¡à¸à¸²à¸£à¸›à¸£à¸±à¸šà¸£à¸²à¸„à¸²à¸•à¸²à¸¡à¸„à¸¸à¸“à¸¥à¸±à¸à¸©à¸“à¸°à¸‚à¸­à¸‡à¸šà¹‰à¸²à¸™ à¹€à¸Šà¹ˆà¸™ à¸«à¹‰à¸­à¸‡à¸™à¹‰à¸³ à¹‚à¸£à¸‡à¸£à¸– à¹à¸¥à¸°à¸­à¸²à¸¢à¸¸à¸šà¹‰à¸²à¸™")

# -----------------------------
# à¹‚à¸«à¸¥à¸”à¸«à¸£à¸·à¸­à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸¡à¹€à¸”à¸¥à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
# -----------------------------
model_path = "model/best_model.pkl"

if not os.path.exists(model_path):
    st.warning("âš ï¸ à¹„à¸¡à¹ˆà¸žà¸šà¹„à¸Ÿà¸¥à¹Œà¹‚à¸¡à¹€à¸”à¸¥ à¸à¸³à¸¥à¸±à¸‡à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸¡à¹€à¸”à¸¥à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸²à¸ train_model.py ...")
    try:
        # à¸£à¸±à¸™ train_model.py à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
        subprocess.run(["python", "train_model.py"], check=True)
        st.success("âœ… à¹‚à¸¡à¹€à¸”à¸¥à¸–à¸¹à¸à¸ªà¸£à¹‰à¸²à¸‡à¹ƒà¸«à¸¡à¹ˆà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§!")
    except Exception as e:
        st.error(f"âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸¡à¹€à¸”à¸¥: {e}")
        st.stop()

# à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸«à¸£à¸·à¸­à¸ªà¸£à¹‰à¸²à¸‡à¹à¸¥à¹‰à¸§
try:
    model = joblib.load(model_path)
    st.success("âœ… à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ")
except Exception as e:
    st.error(f"âŒ à¹‚à¸«à¸¥à¸”à¹‚à¸¡à¹€à¸”à¸¥à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ: {e}")
    st.stop()

# -----------------------------
# à¸ªà¹ˆà¸§à¸™à¸£à¸±à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰
# -----------------------------
st.header("ðŸ“‹ à¸›à¹‰à¸­à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¹‰à¸²à¸™")

col1, col2 = st.columns(2)

with col1:
    OverallQual = st.slider("à¸„à¸¸à¸“à¸ à¸²à¸žà¹‚à¸”à¸¢à¸£à¸§à¸¡à¸‚à¸­à¸‡à¸šà¹‰à¸²à¸™ (OverallQual)", 1, 10, 5)
    GrLivArea = st.number_input("à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸ªà¸­à¸¢ (à¸•à¸£.à¸Ÿà¸¸à¸•)", 500, 5000, 1500)
    GarageCars = st.slider("à¸ˆà¸³à¸™à¸§à¸™à¸—à¸µà¹ˆà¸ˆà¸­à¸”à¸£à¸–à¹ƒà¸™à¹‚à¸£à¸‡à¸£à¸–", 0, 4, 2)

with col2:
    TotalBsmtSF = st.number_input("à¸žà¸·à¹‰à¸™à¸—à¸µà¹ˆà¸Šà¸±à¹‰à¸™à¹ƒà¸•à¹‰à¸”à¸´à¸™ (à¸•à¸£.à¸Ÿà¸¸à¸•)", 0, 3000, 800)
    FullBath = st.slider("à¸ˆà¸³à¸™à¸§à¸™à¸«à¹‰à¸­à¸‡à¸™à¹‰à¸³à¹€à¸•à¹‡à¸¡ (FullBath)", 0, 4, 2)
    YearBuilt = st.number_input("à¸›à¸µà¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡à¸šà¹‰à¸²à¸™", 1900, datetime.datetime.now().year, 2005)

# -----------------------------
# à¹€à¸•à¸£à¸µà¸¢à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
# -----------------------------
input_data = pd.DataFrame(
    [[OverallQual, GrLivArea, GarageCars, TotalBsmtSF, FullBath, YearBuilt]],
    columns=["OverallQual", "GrLivArea", "GarageCars", "TotalBsmtSF", "FullBath", "YearBuilt"]
)

# -----------------------------
# à¸›à¸¸à¹ˆà¸¡à¸—à¸³à¸™à¸²à¸¢
# -----------------------------
if st.button("ðŸ” à¸—à¸³à¸™à¸²à¸¢à¸£à¸²à¸„à¸²à¸šà¹‰à¸²à¸™"):
    try:
        log_pred = model.predict(input_data)[0]
        prediction = np.expm1(log_pred)  # à¹à¸›à¸¥à¸‡à¸ˆà¸²à¸ log à¸à¸¥à¸±à¸šà¹€à¸›à¹‡à¸™à¸£à¸²à¸„à¸²

        current_year = datetime.datetime.now().year
        age = current_year - YearBuilt

        # âœ… à¸›à¸£à¸±à¸šà¸£à¸²à¸„à¸²à¸•à¸²à¸¡à¸ˆà¸³à¸™à¸§à¸™à¹‚à¸£à¸‡à¸£à¸–
        if GarageCars == 0:
            prediction *= 0.85
        elif GarageCars == 1:
            prediction *= 0.93
        elif GarageCars == 3:
            prediction *= 1.08
        elif GarageCars == 4:
            prediction *= 1.15

        # âœ… à¸›à¸£à¸±à¸šà¸£à¸²à¸„à¸²à¸•à¸²à¸¡à¸ˆà¸³à¸™à¸§à¸™à¸«à¹‰à¸­à¸‡à¸™à¹‰à¸³
        if FullBath == 0:
            prediction *= 0.9
        elif FullBath == 1:
            prediction *= 0.95
        elif FullBath == 3:
            prediction *= 1.05
        elif FullBath >= 4:
            prediction *= 1.10

        # âœ… à¸›à¸£à¸±à¸šà¸£à¸²à¸„à¸²à¸•à¸²à¸¡à¸­à¸²à¸¢à¸¸à¸šà¹‰à¸²à¸™
        if age > 50:
            prediction *= 0.8
        elif age > 30:
            prediction *= 0.9
        elif age < 10:
            prediction *= 1.1

        # -----------------------------
        # à¹à¸ªà¸”à¸‡à¸œà¸¥à¸¥à¸±à¸žà¸˜à¹Œ
        # -----------------------------
        st.subheader("ðŸ’° à¸œà¸¥à¸à¸²à¸£à¸—à¸³à¸™à¸²à¸¢à¸£à¸²à¸„à¸²à¸šà¹‰à¸²à¸™")
        st.write(f"à¸£à¸²à¸„à¸²à¸šà¹‰à¸²à¸™à¸—à¸µà¹ˆà¸„à¸²à¸”à¸à¸²à¸£à¸“à¹Œ: **${prediction:,.2f}**")
        st.info(f"ðŸ—ï¸ à¸­à¸²à¸¢à¸¸à¸šà¹‰à¸²à¸™: {age} à¸›à¸µ | ðŸš— à¹‚à¸£à¸‡à¸£à¸–: {GarageCars} à¸Šà¹ˆà¸­à¸‡ | ðŸ› à¸«à¹‰à¸­à¸‡à¸™à¹‰à¸³: {FullBath} à¸«à¹‰à¸­à¸‡")

    except Exception as e:
        st.error(f"à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸—à¸³à¸™à¸²à¸¢: {e}")

# -----------------------------
# à¸ªà¹ˆà¸§à¸™à¸—à¹‰à¸²à¸¢
# -----------------------------
st.markdown("---")
st.caption("ðŸ¤– à¸žà¸±à¸’à¸™à¸²à¹‚à¸”à¸¢ à¹€à¸ªà¸Žà¸à¸§à¸¸à¸’à¸´ | à¸§à¸´à¸Šà¸² AI | à¸¡à¸‚.")
